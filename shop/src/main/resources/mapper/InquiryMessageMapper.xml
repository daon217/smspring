<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.sm.app.repository.InquiryMessageRepository">

    <!-- 문의 메시지 테이블 매핑 및 조회 쿼리 정의 -->

    <resultMap id="InquiryMessageResultMap" type="edu.sm.app.dto.InquiryMessage">
        <id property="messageId" column="message_id" />
        <result property="inquiryId" column="inquiry_id" />
        <result property="senderId" column="sender_id" />
        <result property="senderType" column="sender_type" />
        <result property="content" column="content" />
        <result property="createdAt" column="created_at" />
    </resultMap>

    <sql id="inquiryMessageColumns">
        message_id, inquiry_id, sender_id, sender_type, content, created_at
    </sql>

    <select id="selectAll" resultMap="InquiryMessageResultMap">
        SELECT <include refid="inquiryMessageColumns"/>
        FROM cust_inquiry_message
        ORDER BY created_at DESC
    </select>

    <select id="select" parameterType="int" resultMap="InquiryMessageResultMap">
        SELECT <include refid="inquiryMessageColumns"/>
        FROM cust_inquiry_message
        WHERE message_id = #{messageId}
    </select>

    <insert id="insert" parameterType="edu.sm.app.dto.InquiryMessage" useGeneratedKeys="true" keyProperty="messageId">
        INSERT INTO cust_inquiry_message
        (inquiry_id, sender_id, sender_type, content, created_at)
        VALUES (#{inquiryId}, #{senderId}, #{senderType}, #{content}, NOW())
    </insert>

    <update id="update" parameterType="edu.sm.app.dto.InquiryMessage">
        UPDATE cust_inquiry_message
        SET content = #{content}
        WHERE message_id = #{messageId}
    </update>

    <delete id="delete" parameterType="int">
        DELETE FROM cust_inquiry_message WHERE message_id = #{messageId}
    </delete>

    <select id="selectByInquiry" parameterType="int" resultMap="InquiryMessageResultMap">
        <!-- 특정 문의방의 대화를 시간 순서대로 가져오기 -->
        SELECT <include refid="inquiryMessageColumns"/>
        FROM cust_inquiry_message
        WHERE inquiry_id = #{inquiryId}
        ORDER BY created_at ASC
    </select>

    <delete id="deleteByInquiry" parameterType="int">
        <!-- 문의 종료 시 관련 대화 로그를 일괄 삭제 -->
        DELETE FROM cust_inquiry_message WHERE inquiry_id = #{inquiryId}
    </delete>
</mapper>
